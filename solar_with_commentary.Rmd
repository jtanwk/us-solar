---
title: "Shining a Light on U.S. Solar Energy Generation"
author: "Jonathan Tan"
date: "2/3/2019"
output: 
  html_notebook:
    code_folding: hide
---

```{r setup}
knitr::opts_chunk$set(echo = TRUE)

# Data analysis libraries
library(tidyverse)
library(magrittr) # extended pipe functionality
library(lubridate) # dealing with date objects
library(here) # for OS-agnostic filepaths
library(readxl) # for reading Excel files

# Visualization libraries
library(ggrepel) # for neater text labels
library(gghighlight) # for easier highlighting
library(geofacet) # for making facets looks like the USA
library(extrafont) # for... extra fonts
library(gridExtra) # for combining plots

# Geospatial tools and related libraries
library(sf)
library(zipcode) # for geocoding zipcodes
library(noncensus) # for more geocoding data 
library(rnaturalearth)
library(rnaturalearthdata)

# Load previously-imported data
load(here('data', 'solar_data_master.RData'))
```


```{r theme}
# Set custom theme
theme_custom <- function(base_size = 12, base_family = "", 
                         base_line_size = base_size/22,
                         base_rect_size = base_size/22) {
  theme_minimal(base_size = base_size, base_family = base_family,
             base_line_size = base_line_size,
             base_rect_size = base_rect_size) %+replace%
    theme(panel.grid.minor = element_blank(),
          panel.grid.major = element_line(color = "#EEEEEE"),
          plot.title = element_text(family = "Asap SemiBold",
                                    size = 16,
                                    hjust = 0,
                                    margin = margin(5, 0, 5, 0),
                                    color = "#0F0F0F"),
          plot.subtitle = element_text(family = "Asap",
                                       size = 12,
                                       hjust = 0,
                                       margin = margin(0, 0, 10, 0),
                                       color = "#3F3F3F"),
          plot.caption = element_text(family = "Asap",
                                      face = "italic",
                                      size = 8,
                                      hjust = 1,
                                      margin = margin(5, 0, 0, 0)),
          axis.ticks = element_blank(),
          axis.title = element_text(family = "Asap SemiBold",
                                   size = 12,
                                   face = "plain",
                                   margin = margin(10, 10, 10, 10)),
          legend.title = element_text(family = "Asap SemiBold",
                                      size = 10,
                                      color = "#3F3F3F"),
          legend.text = element_text(family = "Asap",
                                     size = 10,
                                     color = "#3F3F3F"),
          strip.text = element_text(family = "Asap Medium",
                                    size = 10,
                                    color = "#3F3F3F",
                                    margin = margin(10, 10, 10, 10)))
}
```

# Introduction

Investment in renewable energy is such a fascinating policy area. It's one of the few that feature the interplay of energy as a national utility, yet with semi-reliance on individuals and corporations as contributors to industry supply - e.g. in installing solar panels or, at a greater scale, solar farms. 

Much of the national conversation around renewable energy today tends to revolve around switching from gasoline power to low-emission alternatives (say, a regular petrol car vs. a Tesla, or a city transit system switching to electric buses). In many cases, this makes sense - the Department of Energy states that ["electricity is less expensive than gasoline and [electric vehicles] are more efficient than gasoline vehicles"](https://www.energy.gov/eere/electricvehicles/saving-fuel-and-vehicle-costs). 

More efficient or not, however, this still shifts the energy load from gasoline to the electrical grid, which itself is mostly generated from non-renewable sources. The *generation* of energy from renewable sources is a critical part of reducing emissions when we as a species increasingly consume more and more energy (looking at you, bitcoin miners). The question I'm more preoccupied with is: where is all this energy coming from? 

# Where all this energy is coming from

First, we'll take a look at data on solar photovoltaic energy generated by the commercial, industrial, power and residential sectors, courtesy of the U.S. Energy Information Administration's [State Energy Data Systems (SEDS) database](https://www.eia.gov/state/seds/).

Why focus on solar energy? Of all the common sources of renewable energy - solar, wind, hydroelectric, geothermal, etc. - solar energy fascinates me because it's so *participatory*. You can't install a wind turbine in your backyard or dam up the local river, but you could invest in a set of solar panels for your house fairly easily. In the SEDS data, solar energy is also the only renewable source of energy to have a line item for "generation by small-scale applications in the residential sector".

```{r gen-by-source, warning=FALSE, fig.align = 'center', fig.width = 4, fig.height = 3}
gen %>%
  group_by(Year, source, energy_type) %>%
  summarize(total_btu = sum(Data)) %>% 
  mutate(full_source = paste0(energy_type, ", ", source)) %>%
  mutate(highlight_col = ifelse(source == "Residential", "2",
                              ifelse(energy_type == "Solar", "1", "0"))) %>% 
  ##### PLOT BEGINS
  ggplot(aes(x = Year, y = total_btu, group = full_source, color = highlight_col)) +
  geom_line(show.legend = FALSE, 
            na.rm = TRUE) +
  scale_color_manual(values = c("#DDDDDD", "#FF810F", "#5D2BF0")) +  
  labs(title = "Residential systems are the 2nd-largest source of solar energy",
       subtitle = "While utility-owned solar farms were the largest generators of solar energy in 2016, small-scale \nresidential systems overtook the commercial sector in 2014 to become the 2nd-largest source \nof solar energy and the 5th-largest source of renewable energy overall.",
       x = "Year",
       y = "Log Annual Energy Generated (BTUs)",
       caption = "Data source: SEDS (U.S. Energy Information Administration)") +
  geom_text_repel(data = . %>% filter(Year == 2016),
                  aes(x = Year, y = total_btu, label = full_source),
                  size = 3,
                  hjust = 0,
                  nudge_x = 1,
                  family = "Asap Medium",
                  show.legend = FALSE,
                  na.rm = TRUE) +
  scale_y_log10(breaks = c(10, 100, 1000, 10000, 100000),
                labels = c("10", "100", "1K", "10K", "100K")) +
  scale_x_continuous(limits = c(1960, 2030),
                     breaks = seq(1960, 2010, 10)) +
  annotate(geom = "text", x = 2017, y = 5, 
           label = "Solar energy is the only \nrenewable energy source in \nthe data with a Residential \ncategory.",
           size = 3,
           lineheight = 1,
           color = "#000000",
           hjust = 0, vjust = 1,
           family = "Asap",
           fontface = "italic") + 
  theme_custom() +
  theme(panel.grid.major.x = element_blank())

# ggsave(here('output', 'gen-by-source.png'), width = 8, height = 6)
```

A logical next question is: who's actually capturing all this solar energy? 

```{r gen-by-state, fig.align = 'center', fig.width = 4, fig.height = 4}
gen %>%
  filter(Year == max(Year)) %>%
  filter(source == "Residential") %>%
  group_by(StateCode) %>%
  summarize(total_btu = sum(Data)) %>%
  mutate(dev_fr_median = total_btu / median(total_btu, na.rm = TRUE)) %>% 
  filter(dev_fr_median != 0) %>% # SD and ND mess with log scale 
  mutate(highlight = ifelse(dev_fr_median > 1, TRUE, FALSE)) %>%
  ##### PLOT BEGINS
  ggplot(aes(x = reorder(StateCode, dev_fr_median), y = dev_fr_median, color = highlight)) +
  geom_point(stat = 'identity', 
             show.legend = FALSE,
             na.rm = TRUE) + 
  geom_text(aes(label = StateCode, 
                 y = ifelse(dev_fr_median > 1, dev_fr_median * 1.3, dev_fr_median / 1.3)),
            show.legend = FALSE,
            size = 3.5) +
  geom_hline(yintercept = 1, 
             color = "#BFBFBF",
             linetype = "dashed") +
  scale_y_log10(position = "right",
                breaks = c(0.01, 0.1, 1, 10, 100),
                labels = c("0.01x", "0.1x", "1x", "10x", "100x")) +
  scale_x_discrete(expand = c(0.03, 0)) +
  scale_color_manual(values = c("#5D2BF0", "#FF810F")) +
  labs(title = "CA generates over 200x more solar energy than the national median",
       subtitle = "In 2016, California was the single largest generator of solar energy from small-scale residential \nsystems, producing more than 214 times the solar energy than the median state. \nSD and ND are omitted below, having produced no solar energy in 2016.",
       x = "", 
       y = "Solar Energy Generated Relative to Median State",
       caption = "Data source: SEDS (U.S. Energy Information Administration)") +
  annotate("segment", 
           x = "AL", xend = "AL", 
           y = 1.2, yend = 3.2, 
           arrow = arrow(length = unit(0.2, "cm")),
           color = "#000000") +
  annotate("segment", 
           x = "AL", xend = "AL",
           y = 0.8, yend = 0.3, 
           arrow = arrow(length = unit(0.2, "cm")),
           color = "#000000") +
  annotate("text", 
           x = "WY", y = 1.2, 
           label = "Generated \nmore solar energy \nthan median",
           family = "Asap",
           fontface = "italic",
           color = "#000000", 
           size = 3,
           lineheight = 1,
           hjust = 0) +
  annotate("text", 
           x = "WY", y = 0.8, 
           label = "Generated \nless solar energy \nthan median",
           family = "Asap",
           fontface = "italic",
           color = "#000000", 
           size = 3,
           lineheight = 1,
           hjust = 1) +
  theme_custom() + 
  theme(panel.grid.major.y = element_blank(),
        axis.text.y = element_blank()) +
  coord_flip()

# ggsave(here('output', 'gen-by-state-mul.png'), width = 8, height = 8)

# TODO: Add explanatory annotations to extremes, perhaps with goofy comparisons
```

Unsurprisingly, California was the single largest **residential** generator of solar energy in 2016 - in fact, California and Arizona combined generated more than half of the national total. What is a bit more of a surprise is how high on the list the Northeast states like New York (#3), New Jersey (#4), and Massachussetts (#6) lie, particularly in comparison to known sunny states like Nevada (#9), Texas (#10) and Florida (#13).

That brings me to my next question: does the amount of sunlight each state receives correlate with the solar energy it generates? 

# Do sunny states generate more solar energy?

For this, we'll use solar irradiance data from the Department of Energy's [National Renewable Energy Laboratory](https://www.nrel.gov/gis/data-solar.html). Specifically, we're looking at Global Horizontal Irradiance (GHI), which is the amount of solar radiation a surface receives if placed horizonal to the ground, measured in kilowatt-hours per square meter per day ($kWh/m^2/day$). Since we're dealing with residential installations here, roofs might be sloped in a particular direction, but we'll assume that they more or less average out to horizontal position in the full dataset. 

```{r, include = FALSE, message = FALSE, results = 'hide'}
# Read state- and county-level shapefiles
us_states <- ne_states(country = "united states of america",
                       returnclass = "sf")
county_map <- st_read(here::here('data', 'shapefiles-usa', 'cb_2017_us_county_500k'))

# Get county and zip code fips code data
data(counties)
data(zip_codes)

# zip_codes FIPS data is in numeric formats, drops leading 0s
zip_codes %<>%
  mutate(fips = as.character(fips)) %>%
  mutate(fips = ifelse(nchar(fips) == 4, 
                       paste0("0", fips),
                       fips))
```


```{r, message = FALSE, warning = FALSE, fig.width = 6, fig.height = 2.5}
# Specify map bounds 
bounds <- data_frame(LONG = c(-122, -64),
                     LAT = c(24, 49)) %>%
  st_as_sf(coords = c("LONG", "LAT"),
           crs = 4326) %>%
  st_transform(crs = 2163) %>%
  st_coordinates()

# Plot Solar Panel Map
map1 <- county_map %>%
  st_transform(2163) %>%
  mutate(COUNTYFP = as.character(COUNTYFP)) %>%
  left_join(panels %>%
              filter(install_type == "residential") %>%
              select(zipcode) %>%
              left_join(zip_codes, by = c("zipcode" = "zip")) %>%
              group_by(fips) %>%
              count(),
            by = c("GEOID" = "fips")) %>%
  left_join(counties %>%
              mutate(GEOID = paste0(state_fips, county_fips)) %>%
              select(GEOID, population),
            by = c("GEOID" = "GEOID")) %>%
  mutate(panels_per_10k = ((n * 10000) / population)) %>%
  ggplot() +
  geom_sf(aes(fill = panels_per_10k),
          color = "transparent") + 
  geom_sf(data = us_states,
          fill = "transparent",
          color = "#FFFFFF",
          size= 0.1) +
  coord_sf(xlim = bounds[, 1], 
           ylim = bounds[, 2]) +
  scale_fill_gradient(low = "#5D2BF0", high = "#FF810F",
                      #low = "#1949E3", high = "#EE4A1E",
                      na.value = "#FFFFFF",
                      name = "Panels per 10,000 people",
                      breaks = seq(0, 400, 50),
                      guide = guide_legend(
                        direction = "horizontal",
                        keyheight = unit(2, units = "mm"),
                        keywidth = unit(10, units = "mm"),
                        title.position = "top",
                        title.hjust = 0,
                        label.hjust = 1,
                        nrow = 1,
                        byrow = TRUE,
                        label.position = "bottom"
                      )) +
  labs(title = "Where the solar panels are...",
       subtitle = "Panels per 10K people by county",
       caption = "Data source: OpenPV Project (U.S. Dept of Energy)") +
  theme_custom() +
  theme(panel.grid = element_line(color = "#FFFFFF"),
        axis.text = element_blank(),
        axis.title = element_blank(),
        legend.position = "bottom",
        legend.title = element_text(size = 8))

# Plot Solar Resource Map 
map2 <- us_states %>%
  st_transform(2163) %>%
  left_join(ghi %>%
              filter(period == "Ann") %>%
              select(State, avg),
            by = c("name" = "State")) %>%
  ggplot() +
  geom_sf(aes(fill = avg),
          color = "transparent") +
  coord_sf(xlim = bounds[, 1], 
           ylim = bounds[, 2]) +
  scale_fill_gradient(low = "#5D2BF0", high = "#FF810F",
                      na.value = "#FFFFFF",
                      name = "Annual Solar Resource (kWh/m^2/day)",
                      breaks = seq(3, 6, 0.5),
                      guide = guide_legend(
                        direction = "horizontal",
                        keyheight = unit(2, units = "mm"),
                        keywidth = unit(10, units = "mm"),
                        title.position = "top",
                        title.hjust = 0,
                        label.hjust = 1,
                        nrow = 1,
                        byrow = TRUE,
                        label.position = "bottom"
                      )) +
  labs(title = "...versus how much sun they get",
       subtitle = "Average annual solar irradiance by state",
       caption = "Data source: NREL (U.S. Dept of Energy)") +
  theme_custom() +
  theme(legend.position = "bottom",
        legend.title = element_text(size = 8),
        panel.grid = element_line(color = "#FFFFFF"),
        axis.text = element_blank(),
        axis.title = element_blank())

grid.arrange(map1, map2, ncol = 2)
# pair_map <- grid.arrange(map1, map2, ncol = 2)
# ggsave(filename = here::here('output', 'map-pair.png'),
#       plot = pair_map,
#       width = 12, height = 5)
```


As we've seen before, map pairs aren't the best at showing correlation. So let's try another way of looking at how solar energy generation correlates with solar irradiance.

```{r ghi-vs-gen, warning = FALSE, message = FALSE, fig.align = 'center', fig.width = 4, fig.height = 3}
gen %>%
  filter(Year == 2016) %>%
  filter(source == "Residential") %>%
  group_by(StateCode) %>%
  summarize(total_btu = sum(Data)) %>%
  left_join(ghi %>% 
               mutate(StateCode = state.abb[match(State, state.name)]) %>%
               filter(period == "Ann", !is.na(avg)) %>%
               select(StateCode, avg),
             by = c("StateCode" = "StateCode")) %>% 
  filter(total_btu != 0) %>%  # SD and ND mess with log scale
  mutate(region = state.region[match(StateCode, state.abb)]) %>%
  mutate(highlight = ifelse(region == "Northeast", "Northeast", "North Central, \nSouth & West")) %>%
  ##### PLOT BEGINS
  ggplot(aes(x = avg, y = total_btu, label = StateCode, color = highlight)) +
  geom_point(show.legend = FALSE,
             na.rm = TRUE) +
  geom_text_repel(show.legend = FALSE,
                  na.rm = TRUE,
                  family = "Asap") +
  geom_smooth(aes(x = avg, y = total_btu),
              method = "lm",
              color = "black",
              size = 0.5,
              linetype = "dashed",
              se = FALSE,
              inherit.aes = FALSE,
              na.rm = TRUE) +
  scale_y_log10(expand = c(0.1, 0),
                breaks = c(1, 10, 100, 1000, 10000),
                labels = c("1", "10", "100", "1K", "10K")) +
  scale_color_manual(values = c("#DDDDDD", "#5D2BF0"),
                     name = "Region") +
  labs(title = "Northeast states generate more solar energy from less sunlight",
       subtitle = "Relative to states in the North Central, South, and West regions, states in the Northeast generated \nmore solar energy in 2016 than what their solar irradiance levels might suggest.",
       x = "Average Annual Global Horizonal Irradiance (kWh/m^2/day)",
       y = "Log Solar Energy Generated in 2016 (BTUs)",
       caption = "Data sources: NREL (U.S. Dept of Energy), SEDS (U.S. Energy Information Administration)") +
  annotate("segment", 
           x = 3.8, xend = 3.55, y = 5000, yend = 5000,
           arrow = arrow(length = unit(0.2, "cm")),
           color = "#000000") +
  annotate("segment", 
           x = 5.45, xend = 5.7, y = 5000, yend = 5000,
           arrow = arrow(length = unit(0.2, "cm")),
           color = "#000000") +
  annotate("text",
           x = 3.8, y = 3800, 
           label = "Gets less sun",
           color = "#000000",
           family = "Asap",
           fontface = "italic",
           size = 3, 
           hjust = 1) +
  annotate("text", 
           x = 5.45, y = 3800, 
           label = "Gets more sun",
           color = "#000000",
           family = "Asap",
           fontface = "italic",
           size = 3, 
           hjust = 0) +
  annotate("text",
           x = 3.7, y = 1300,
           label = "Northeast states",
           color = "#5D2BF0",
           family = "Asap Bold",
           size = 4,
           hjust = 0) +
  annotate("text",
           x = 5.0, y = 20,
           label = "North Central, \nSouth & West \nstates",
           lineheight = 1,
           color = "#DDDDDD",
           family = "Asap Bold",
           size = 4,
           hjust = 0.5) +
  theme_custom() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        legend.position = c(0.87, 0.15),
        legend.background = element_rect(color = "#BFBFBF"))

# ggsave(here('output', 'ghi-vs-gen.png'), width = 8, height = 6)
```

A rough upward trend seems to hold for the Western states, although there seems to be a lot of unexplained variation towards the lower end of the irradiance range. Among the Northeast states in red above, New York, New Jersey, and Massachussetts in particular are generating way more solar energy than neighboring states that get just as much sunlight, if not more.

While there are plenty of factors that impact the efficiency with which you generate solar energy - tilt, weather, temperature, age of technology, etc. - my immediate guess is that the most straightforward way to ramp up your output is to have more solar panels. 

# Which states have the most solar panels?

To answer this question, we'll use historical solar panel installation data from [OpenPV](https://openpv.nrel.gov/), the open-source database maintained by NREL. 

An easy way for a state to have lots of solar panels is to have lots of people, but that's not a particularly novel insight. Thus, a critical second step is to normalize our solar panel counts by population size - this lets us identify the states with high numbers of solar panels relative to how many people they have. 

This data is normally collected by the Census bureau, but the [National Cancer Institute](https://seer.cancer.gov/popdata/download.html) has a nicely-bundled dataset that combines census counts and inter-census estimates from 1969 to 2016. So that is the dataset we'll use to wrangle both solar panel data into count-per-10,000-people estimates.

Now, let's briefly check which states have the largest number of residential solar panels installed relative to the number of residents they have.

```{r panels-by-pop-state, fig.align = 'center', fig.width = 4, fig.height = 3}
panels_by_pop %>%
  mutate(region = state.region[match(state, state.abb)]) %>%
  mutate(region = factor(region,
                         levels = c("West", "Northeast", "South", "North Central"))) %>%
  mutate(highlight = ifelse(region == "Northeast", TRUE, FALSE)) %>%
  filter(!is.na(region)) %>%
  filter(year == 2016) %>%
  ggplot(aes(x = reorder(state, -panels_per_10k), 
             y = panels_per_10k,
             fill = highlight)) +
  geom_bar(stat = 'identity',
           show.legend = FALSE) +
  facet_grid(. ~ region,
             scales = "free_x",
             space = "free_x") +
  # geom_text(data = data_frame(state = "NJ",
  #                                panels_per_10k = 95,
  #                                region = factor("Northeast",
  #                                   levels = c("West", "Northeast", "South", "North Central")),
  #                                highlight = TRUE),
  #           aes(label = "MA had the 3rd-most \nhousehold solar panels \nper capita"),
  #           hjust = 0,
  #           vjust = 1,
  #           size = 3,
  #           color = "grey40",
  #           nudge_x = -0.3) +
  scale_fill_manual(values = c("#DDDDDD", "#5D2BF0")) +
  labs(title = 'Northeast states are surprisingly well-represented in solar panel counts',
       subtitle = 'Adjusting for state population size, NY, MA, and NJ have the 3rd, 5th and 10th-most residential \nsolar panel installations per capita respectively.',
       x = 'State',
       y = 'Panels per 10,000 people',
       caption = 'Data sources: NREL (U.S. Dept of Energy), National Cancer Institute') +
  theme_custom() +
  theme(axis.text.x = element_text(angle = 90, 
                                   vjust = 0.5,
                                   margin = margin(0, 0, 10, 0)),
        panel.grid.major.x = element_blank())

# ggsave(here('output', 'panels-by-pop-state.png'), width = 8, height = 6)
```

Sure enough - Northeast states like Massachussetts, New Jersey, and Connecticut are among states with the most solar panels per capita in 2016. It's also worth exploring how this ranking has changed over time:

```{r state-panel-rank, fig.align = 'center', fig.width = 4, fig.height = 5}
panels_by_pop %>%
  select(state, year, panels_per_10k) %>%
  mutate(region = state.region[match(state, state.abb)]) %>%
  filter(!is.na(region)) %>%
  group_by(year) %>%
  arrange(year, desc(panels_per_10k)) %>%
  mutate(ranking = row_number()) %>%
  mutate(highlight = ifelse(state %in% c("VT", "ID"), state, "Other")) %>% 
  ##### PLOT BEGINS
  ggplot(aes(x = year, y = ranking, group = state, color = highlight)) +
  geom_line(na.rm = TRUE,
            show.legend = FALSE) +
  geom_point(na.rm = TRUE,
             show.legend = FALSE) +
  geom_text(data = . %>% filter(year == 1995),
            aes(x = year, y = ranking, label = state, color = highlight),
            nudge_x = -1,
            size = 3.5,
            show.legend = FALSE) +
  geom_text(data = . %>% filter(year == 2016),
            aes(x = year, y = ranking, label = state, color = highlight),
            nudge_x = 1,
            size = 3.5,
            show.legend = FALSE) +
  scale_y_reverse() +
  scale_x_continuous(limits = c(1993, 2018),
                     breaks = seq(1995, 2015, 5)) +
  scale_color_manual(values = c("#5D2BF0", "#DDDDDD", "#FF810F")) +
  labs(title = "VT has seen biggest overall increase in ranking of solar panels per capita",
       subtitle = "Ranking states by solar panels per capita, Vermont rose from #46 in 1995 to #11 in 2016. \nMeanwhile, Idaho saw the largest drop, moving from #3 in 1995 to #42 in 2016.",
       x = "Year",
       caption = "Data sources: NREL (US Dept of Energy), National Cancer Institute") +
  theme_custom() +
  theme(panel.grid = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_text(margin = margin(0, 0, 10, 0)))

ggsave(here('output', 'state-panel-rank.png'), width = 8, height = 10)
```


The question now becomes - **why**? As we saw before, the Northeast region as a group receives the lowest annual solar irradiance among all the states. I definitely wouldn't go to Boston for a beach weekend.  

A simple hypothesis is that some of these states pursue more "green" policies compared to other states. In order to compare them, however, how do we quantify a state's commitment to environmental policy? 

One way we'll explore below is to look at how they spend their money. Specifically, many states create financial incentives for residents to invest in solar panels by offering loan programs, surplus solar energy buybacks (more on this later), and otherwise allowing for tax exemptions or credits. Which states do this, and to what extent?

# Decreasing the cost of Solar Panels with Tax Incentives

Here, I'm interested in the effect of state and federal policies that provide tax incentives for installing renewable energy systems. We know that the federal solar tax credit incentive was implemented in 2005 and is still in effect. For individual states, we'll have to look at data from the [Database of State Incentives for Renewables & Efficiency (DSIRE)](http://www.dsireusa.org/resources/data-and-tools/) maintained by N.C. State University. 

Let's look at which states provided renewable tax incentives specifically for residential photovoltaic systems (i.e. household-scale solar panels) and when: 

```{r policy-by-state-year, warning=FALSE, message=FALSE, fig.align = 'center', fig.width = 4, fig.height = 5}
policy %>%
  filter(sector == "Residential") %>% 
  filter(!program_type %in% c("Corporate Tax Credit")) %>%
  select(state, start_date, end_date) %>%
  mutate(start_year = year(start_date),
         end_year = ifelse(end_date > now(), NA, year(end_date))) %>% 
  select(state, start_year, end_year) %>%
  group_by(state) %>% 
  mutate(start_year = min(start_year), 
         end_year = max(end_year)) %>%
  mutate(end_year = ifelse(is.na(end_year), 2019, end_year)) %>%
  unique() %>% 
  ungroup() %>% 
  rowwise() %>%
  do(data.frame(state = .$state, 
                year = seq(.$start_year, .$end_year, by = 1))) %>%
  mutate(policy = 1) %>%
  complete(nesting(state), year, fill = list(policy = 0)) %>%
  mutate(region = state.region[match(state, state.name)]) %>%
  mutate(region = factor(region, levels = c("West", "Northeast", "South", "North Central"))) %>%
  mutate(stateabb = state.abb[match(state, state.name)]) %>%
  filter(!is.na(stateabb)) %>%
  group_by(state) %>%
  mutate(num_years = sum(policy)) %>%
  mutate(policy = ifelse(policy == 1, TRUE, FALSE)) %>%
  ##### PLOT BEGINS
  ggplot(aes(x = year, y = reorder(stateabb, num_years))) +
  geom_tile(aes(fill = policy),
            color = "white",
            size = 0.5) +
  # facet_grid(region ~ .,
  #            scales = "free_y",
  #            space = "free_y") +
  scale_fill_manual(breaks = c(TRUE),
                    values = c("#DDDDDD", "#FF810F"),
                    name = "Residential ITCs in Effect?") +
  scale_x_continuous(position = "top",
                     breaks = c(1980, 1990, 2000, 2010)) +
  labs(title = "Renewable tax incentives only took off in mid-2000s",
       subtitle = "Massachussetts, New York, and Iowa were the first states to offer tax incentives to households \nthat installed solar panels. Most other states followed after the federal Solar Investment Tax \nCredits (ITCs) began in 2006.",
       x = "Year",
       y = "State",
       caption = "Data source: DSIRE (NC State Univ.)") +
  annotate("rect",
           xmin = 1975.5, xmax = 1987.5, ymin = 36.5, ymax = 40.5,
           color = "#FFFFFF",
           fill = "#FFFFFF", 
           alpha = 0.7) +
  annotate("text",
           x = 1976, y = "WY",
           label = "MA, NH, and IA first introduced \nproperty tax exemptions for \nsolar panel owners between \n1975 and 1978.",
           size = 3,
           lineheight = 1,
           hjust = 0, vjust = 1,
           family = "Asap",
           fontface = "italic",
           color = "#000000") +
  annotate("rect",
           xmin = 1992.5, xmax = 2003.5, ymin = 21.5, ymax = 25.5,
           color = "#FFFFFF",
           fill = "#FFFFFF",
           alpha = 0.7) +
  annotate("text",
           x = 1993, y = "WA",
           label = "More states began offering \ntax incentives in the early \n2000s, most of which have \ncontinued to present day.",
           size = 3,
           lineheight = 1,
           hjust = 0, vjust = 1,
           family = "Asap",
           fontface = "italic",
           color = "#000000") +
  annotate("rect",
           xmin = 1995.5, xmax = 2007.5, ymin = 5.5, ymax = 9.5,
           color = "#FFFFFF",
           fill = "#FFFFFF",
           alpha = 0.7) +
  annotate("text",
           x = 1996, y = "WI",
           label = "In other states, budgets for \nincentives have run out and \nthe bills providing funding for \nthem have not been renewed.",
           size = 3,
           lineheight = 1,
           hjust = 0, vjust = 1,
           family = "Asap",
           fontface = "italic",
           color = "#000000") +
  theme_custom() +
  theme(panel.grid = element_blank(),
        axis.title.y = element_blank(),
        legend.position = c(0.8, 0.93),
        legend.background = element_rect(fill = "#FFFFFF",
                                         linetype = "blank"),
        axis.text.y.left = element_text(margin = margin(0, 0, 0, 20)))

# ggsave(here('output', 'policy-by-state-year.png'), width = 8, height = 10)
```

It appears that the availability of renewable ITCs only tell part of the story. Among the states that we were previously interested in, Massachussetts (along with Iowa and New Hampshire) was among the earliest states in the country to implement tax incentive programs in the form of property tax exemptions between 1975 and 1980. New York only implemented a similar property tax exemption in 1988. Meanwhile, the earliest incentive program available to the residential sector in New Jersey was the adoption of Solar Renewable Energy Certificates (SREC) in 2004, where the state could purchase surplus solar energy from households via SRECs in order to meet the renewable energy production quota set in its Renewable Portfolio Standard. 

How does the availability of these incentives correspond with solar panel installation rates in each state? Do installation rates increase when they're financially incentivized?

```{r panels-vs-policy, warning=FALSE, message=FALSE, fig.align = 'center', fig.width = 5, fig.height = 4}
# Plot of solar panel installation growth vs. 
panels_by_pop %>%
  select(state, year, panels_per_10k) %>%
  mutate(region = state.region[match(state, state.abb)]) %>%
  ##### PLOT BEGINS 
  ggplot() +
  geom_step(aes(x = year, y = panels_per_10k)) +
  geom_rect(data = policy %>%
              filter(sector == "Residential") %>%
              filter(!program_type %in% c("Corporate Tax Credit")) %>%
              select(state, start_date, end_date) %>%
              mutate(state = state.abb[match(state, state.name)]) %>%
              filter(!is.na(state)) %>%
              mutate(region = state.region[match(state, state.abb)]) %>%
              mutate(region = factor(region,
                       levels = c("North Central", "West", "Northeast", "South"))) %>%
              mutate(start_year = year(start_date),
                     end_year = ifelse(end_date > now(), NA, year(end_date))) %>%
              select(state, start_year, end_year, region) %>%
              group_by(state) %>%
              mutate(start_year = min(start_year),
                     end_year = max(end_year)) %>%
              mutate(end_year = ifelse(is.na(end_year), 2019, end_year)) %>%
              unique(),
            aes(xmin = start_year, xmax = end_year, ymin = 0, ymax = Inf,
                fill = region), 
            alpha = 0.5) +
  facet_geo(~ state) +
  scale_y_log10(breaks = c(0.01, 1, 100),
                labels = c(0.01, 1, 100)) +
  scale_x_continuous(breaks = c(1970, 1990, 2010),
                     labels = c("'70", "'90", "'10")) +
  scale_fill_manual(name = "Region",
                    values = c('#FF810F','#377eb8', '#5D2BF0', '#4daf4a'),
                    guide = guide_legend(nrow = 2,
                                         title.position = "top",
                                         title.hjust = 0)) +
  labs(title = "No clear link between residential tax incentives and solar panel uptake",
       subtitle = "Most states appear to have periods of solar panel growth unrelated to the period at which state-based tax incentives \nfor residential renewable energy systems are available in that state. These periods are highlighted below.",
       x = "Year",
       y = "Log Panels per 10,000 people",
       caption = "Data sources: NREL (US Dept of Energy), DSIRE (NC State Univ.)") +
  theme_custom() +
  theme(strip.text = element_text(margin = margin(2, 0, 2, 0)),
        legend.direction = "horizontal",
        legend.position = c(0.12, 0.97))

# ggsave(here('output', 'panels-vs-policy.png'), width = 10, height = 8)
```

It appears that the periods where state-based financial incentives were available do not meaningfully coincide with periods of rapid solar panel installation growth. We are, however, painting with a very broad brush - the periods we've been looking at have been for all types of state incentives, be it 

Installing a solar panel system may or may not be environmentally-motivated, but we can safely say it is  primarily a financial decision. Buyers put up with a high fixed cost upfront in order to enjoy long-term savings in the future, so the cheaper the cost of installation, the more likely installing solar panels will make financial sense. That suggests we should look at other factors impacting the cost of installing solar panels.  

```{r}
panels %>%
  filter(install_type == "residential") %>%
  filter(year_installed >= 1990) %>% 
  ggplot(aes(x = year_installed, y = cost_per_watt)) +
  # geom_point(alpha = 0.1,
  #            na.rm = TRUE) +
  geom_boxplot(aes(group = year_installed),
               na.rm = TRUE) +
  # geom_smooth(method = "lm",
  #             linetype = "dashed",
  #             na.rm = TRUE) +
  theme_custom()

panels %>%
  filter(install_type == "residential") %>%
  filter(year_installed >= 1990) %>% 
  mutate(year_installed = as.factor(year_installed)) %>%
  ggplot(aes(x = cost_per_watt, y = year_installed)) +
  geom_density_ridges(na.rm = TRUE,
                      scale = 5) +
  theme_custom()

```




# Next steps

As an ongoing project, we will next look at the following factors as possible correlates of solar panel installation rates:

- Cost of electricity in each state 

- Cost of the solar panels themselves

- A deeper look into the types of state tax incentives enacted, i.e. whether it was a tax deduction, a tax credit, a tax exemption, a low-interest loan program, size of the state's renewable portfolio standard, and so on.


# Data Sources

- Solar Energy Generation: [State Energy Data Systems (SEDS), U.S. Energy Information Administration](https://www.eia.gov/state/seds/)

- Solar Irradiance: [National Renewable Energy Laboratory, U.S. Department of Energy](https://www.nrel.gov/gis/data-solar.html)

- Solar Panel Installations: [OpenPV Project, NREL, U.S. Department of Energy](https://openpv.nrel.gov/)

- Population estimates: [Surveillance, Epidemiology and End Results (SEER) Program, National Cancer Institute](https://seer.cancer.gov/popdata/download.html)

- State Policies: [Database of State Incentives for Renewables & Efficiency (DSIRE), North Carolina State University](http://www.dsireusa.org/resources/data-and-tools/)

