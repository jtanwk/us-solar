---
title: "Shining a Light on Solar Energy Generation in the U.S."
author: "Jonathan Tan"
date: "1/27/2019"
output: 
  html_notebook:
    code_folding: hide
---

```{r setup, results = 'hide'}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(magrittr) # extended pipe functionality
library(lubridate) # dealing with date objects
library(ggrepel) # for neater text labels
library(gghighlight) # for easier highlighting
library(extrafont) # for... extra fonts
library(here) 
library(readxl)  

# Set custom theme
theme_custom <- function(base_size = 12, base_family = "", 
                         base_line_size = base_size/22,
                         base_rect_size = base_size/22) {
  theme_minimal(base_size = base_size, base_family = base_family,
             base_line_size = base_line_size,
             base_rect_size = base_rect_size) %+replace%
    theme(panel.grid.minor = element_blank(),
          panel.grid.major = element_line(color = "#EEEEEE"),
          plot.title = element_text(family = "Asap SemiBold",
                                    size = 16,
                                    hjust = 0,
                                    margin = margin(5, 0, 5, 0),
                                    color = "#0F0F0F"),
          plot.subtitle = element_text(family = "Asap",
                                       size = 12,
                                       hjust = 0,
                                       margin = margin(0, 0, 10, 0),
                                       color = "#3F3F3F"),
          plot.caption = element_text(family = "Asap",
                                      face = "italic",
                                      size = 8,
                                      hjust = 1,
                                      margin = margin(5, 0, 0, 0)),
          axis.ticks = element_blank(),
          axis.title = element_text(family = "Asap SemiBold",
                                   size = 12,
                                   face = "plain",
                                   margin = margin(10, 10, 10, 10)),
          legend.title = element_text(family = "Asap SemiBold",
                                      size = 10,
                                      color = "#3F3F3F"),
          legend.text = element_text(family = "Asap",
                                     size = 10,
                                     color = "#3F3F3F"))
}
```

# Introduction

Investment in renewable energy is such a fascinating policy area. It's one of the few that feature the interplay of energy as a national utility, yet with semi-reliance on individuals and corporations as contributors to industry supply - e.g. in installing solar panels or, at a greater scale, solar farms. 

Much of the national conversation around renewable energy today tends to revolve around switching from gasoline power to low-emission alternatives (say, a regular petrol car vs. a Tesla, or a city transit system switching to electric buses). In many cases, this makes sense - the Department of Energy states that ["electricity is less expensive than gasoline and [electric vehicles] are more efficient than gasoline vehicles"](https://www.energy.gov/eere/electricvehicles/saving-fuel-and-vehicle-costs). 

More efficient or not, however, this still shifts the energy load from gasoline to the electrical grid, which itself is mostly generated from non-renewable sources. The *generation* of energy from renewable sources is a critical part of reducing emissions when we as a species increasingly consume more and more energy (looking at you, bitcoin miners). The question I'm more preoccupied with is: where is all this energy coming from? 

# Where all this energy is coming from

First, we'll take a look at data on solar photovoltaic energy generated by the commercial, industrial, power and residential sectors, courtesy of the U.S. Energy Information Administration's [State Energy Data Systems (SEDS) database](https://www.eia.gov/state/seds/).

```{r, warning=FALSE, message=FALSE, results='hide'}
# Import solar energy generation data
gen <- read_csv(here('data', 'data-power-generation', 'Complete_SEDS.csv'))

# Extract desired data and replace labels with actual name of source
# Solar "SO", Wind "WY", Geothermal "GE", Hydroelectric "HY"
gen %<>%
  filter(!StateCode %in% c("US", "X3", "X5")) %>% # filter out Total and Offshore
  mutate(energy_type = substr(MSN, 1, 2)) %>%
  mutate(source = substr(MSN, 3, 5)) %>%
  filter(energy_type %in% c("SO", "WY", "GE", "HY")) %>%
  filter(source %in% c("CCP", "EGP", "ICP", "R7P")) %>%
  mutate(energy_type = ifelse(energy_type == "SO", "Solar",
                              ifelse(energy_type == "WY", "Wind",
                                     ifelse(energy_type == "GE", "Geothermal", 
                                            "Hydroelectric")))) %>%
  mutate(source = ifelse(source == "CCP", "Commercial",
                         ifelse(source == "EGP", "Electric Utility",
                                ifelse(source == "ICP", "Industrial",
                                       "Residential"))))
```

Why focus on solar energy? Of all the common sources of renewable energy - solar, wind, hydroelectric, geothermal, etc. - solar energy fascinates me because it's so *participatory*. You can't install a wind turbine in your backyard or dam up the local river, but you could invest in a set of solar panels for your house fairly easily. In the SEDS data, solar energy is also the only renewable source of energy to have a line item for "generation by small-scale applications in the residential sector".

```{r, warning=FALSE, fig.align = 'center', fig.width = 4, fig.height = 3}
gen %>%
  group_by(Year, source, energy_type) %>%
  summarize(total_btu = sum(Data)) %>% 
  mutate(full_source = paste0(energy_type, ", ", source)) %>%
  mutate(highlight_col = ifelse(source == "Residential", "2",
                              ifelse(energy_type == "Solar", "1", "0"))) %>% 
  ##### PLOT BEGINS
  ggplot(aes(x = Year, y = total_btu, group = full_source, color = highlight_col)) +
  geom_line(show.legend = FALSE, 
            na.rm = TRUE) +
  scale_color_manual(values = c("#CFCFCF", "#FBB907", "#EE4A1E")) +  
  labs(title = "Residential systems are the 2nd-largest source of solar energy",
       subtitle = "While utility-owned solar farms were the largest generators of solar energy in 2016, small-scale \nresidential systems overtook the commercial sector in 2014 to become the 2nd-largest source \nof solar energy and the 5th-largest source of renewable energy overall.",
       x = "Year",
       y = "Log Annual Energy Generated (BTUs)",
       caption = "Data source: SEDS (U.S. Energy Information Administration)") +
  geom_text_repel(data = . %>% filter(Year == 2016),
                  aes(x = Year, y = total_btu, label = full_source),
                  size = 3,
                  hjust = 0,
                  nudge_x = 1,
                  family = "Asap Medium",
                  show.legend = FALSE,
                  na.rm = TRUE) +
  scale_y_log10(breaks = c(10, 100, 1000, 10000, 100000),
                labels = c("10", "100", "1K", "10K", "100K")) +
  scale_x_continuous(limits = c(1960, 2030),
                     breaks = seq(1960, 2010, 10)) +
  annotate(geom = "text", x = 2017, y = 5, 
           label = "Solar energy is the only \nrenewable energy source in \nthe data with a Residential \ncategory.",
           size = 3,
           lineheight = 1,
           color = "#000000",
           hjust = 0, vjust = 1,
           family = "Asap",
           fontface = "italic") + 
  theme_custom() +
  theme(panel.grid.major.x = element_blank())
```

A logical next question is: where are all these residential solar panels? 

```{r, fig.align = 'center', fig.width = 4, fig.height = 4}
gen %>%
  filter(Year == max(Year)) %>%
  filter(source == "Residential") %>%
  group_by(StateCode) %>%
  summarize(total_btu = sum(Data)) %>%
  mutate(dev_fr_median = total_btu / median(total_btu, na.rm = TRUE)) %>% 
  filter(dev_fr_median != 0) %>% # SD and ND mess with log scale 
  mutate(highlight = ifelse(dev_fr_median > 1, TRUE, FALSE)) %>%
  ##### PLOT BEGINS
  ggplot(aes(x = reorder(StateCode, dev_fr_median), y = dev_fr_median, color = highlight)) +
  geom_point(stat = 'identity', 
             show.legend = FALSE,
             na.rm = TRUE) + 
  geom_text(aes(label = StateCode, 
                 y = ifelse(dev_fr_median > 1, dev_fr_median * 1.3, dev_fr_median / 1.3)),
            show.legend = FALSE,
            size = 3.5) +
  geom_hline(yintercept = 1, 
             color = "#BFBFBF",
             linetype = "dashed") +
  scale_y_log10(position = "right",
                breaks = c(0.01, 0.1, 1, 10, 100),
                labels = c("0.01x", "0.1x", "1x", "10x", "100x")) +
  scale_x_discrete(expand = c(0.03, 0)) +
  scale_color_manual(values = c("#1949E3", "#EE4A1E")) +
  labs(title = "CA generates over 200x more solar energy than the national median",
       subtitle = "In 2016, California was the single largest generator of solar energy from small-scale residential \nsystems, producing more than 214 times the solar energy than the median state. \nSD and ND are omitted below, having produced no solar energy in 2016.",
       x = "", 
       y = "Solar Energy Generated Relative to Median State",
       caption = "Data source: SEDS (U.S. Energy Information Administration)") +
  annotate("segment", 
           x = "AL", xend = "AL", 
           y = 1.2, yend = 3.2, 
           arrow = arrow(length = unit(0.2, "cm")),
           color = "#000000") +
  annotate("segment", 
           x = "AL", xend = "AL",
           y = 0.8, yend = 0.3, 
           arrow = arrow(length = unit(0.2, "cm")),
           color = "#000000") +
  annotate("text", 
           x = "WY", y = 1.2, 
           label = "Generated \nmore solar energy \nthan median",
           family = "Asap",
           fontface = "italic",
           color = "#000000", 
           size = 3,
           lineheight = 1,
           hjust = 0) +
  annotate("text", 
           x = "WY", y = 0.8, 
           label = "Generated \nless solar energy \nthan median",
           family = "Asap",
           fontface = "italic",
           color = "#000000", 
           size = 3,
           lineheight = 1,
           hjust = 1) +
  theme_custom() + 
  theme(panel.grid.major.y = element_blank(),
        axis.text.y = element_blank()) +
  coord_flip()
```

Unsurprisingly, California was the single largest **residential** generator of solar energy in 2016 - in fact, California and Arizona combined generated more than half of the national total. What is a bit more of a surprise is how high on the list the Northeast states like New York (#3), New Jersey (#4), and Massachussetts (#6) lie, particularly in comparison to known sunny states like Nevada (#9), Texas (#10) and Florida (#13).

That brings me to my next question: does the amount of sunlight each state receives correlate with the solar energy it generates? 

# Do sunny states generate more solar energy?

For this, we'll use solar irradiance data from the Department of Energy's [National Renewable Energy Laboratory](https://www.nrel.gov/gis/data-solar.html). Specifically, we're looking at Global Horizontal Irradiance (GHI), which is the amount of solar radiation a surface receives if placed horizonal to the ground, measured in kilowatt-hours per square meter per day ($kWh/m^2/day$). Since we're dealing with residential installations here, roofs might be sloped in a particular direction, but we'll assume that they more or less average out to horizontal position in the full dataset. 

```{r, warning=FALSE, message=FALSE}
# Import solar irradiance data
ghi <- read_excel(here('data', 'data-solar-irradiance', 'solarsummaries.xlsx'),
                     sheet = 'GHI State',
                     range = 'A1:BO52',
                     col_types = c('text', rep('numeric', 66)))

# Reshape from wide to long
ghi %<>%
  gather(key = metric, value =  value, -c("State", "State FIPS")) 

# Remove time period from metric name and reshape back to wide-ish
# Now unit of analysis is state-month-estimate instead of state-estimate
ghi %<>%
  mutate(period = substr(ghi$metric, 1, str_locate(ghi$metric, " ") - 1)) %>%
  mutate(attr = substr(ghi$metric, str_locate(ghi$metric, " ") + 1, 
                       nchar(ghi$metric))) %>%
  mutate(period = substr(period, 1, 3)) %>%
  mutate(period = factor(period,
                         levels = c('Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                                    'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec',
                                    'Ann'))) %>%
  select(-metric) %>%
  spread(key = attr, value = value) %>%
  rename(avg = 'Average (kWh/m2/day)',
         max = 'Average Maximum (kWh/m2/day)',
         min = 'Average Minimum (kWh/m2/day)',
         median = 'Average Median (kWh/m2/day)',
         sd = 'Average Standard Deviation (kWh/m2/day)')
```

So how does solar energy generation relate to solar irradiance? 

```{r, fig.align = 'center', fig.width = 4, fig.height = 3}
gen %>%
  filter(Year == max(Year)) %>%
  filter(source == "Residential") %>%
  group_by(StateCode) %>%
  summarize(total_btu = sum(Data)) %>%
  inner_join(ghi %>% 
               mutate(StateCode = state.abb[match(State, state.name)]) %>%
               filter(period == "Ann", !is.na(avg)) %>%
               select(StateCode, avg),
             by = c("StateCode" = "StateCode")) %>% 
  filter(total_btu != 0) %>%  # SD and ND mess with log scale
  mutate(region = state.region[match(StateCode, state.abb)]) %>%
  mutate(highlight = ifelse(region == "Northeast", "Northeast", "North Central, \nSouth & West")) %>%
  ##### PLOT BEGINS
  ggplot(aes(x = avg, y = total_btu, label = StateCode, color = highlight)) +
  geom_point() +
  geom_text_repel(show.legend = FALSE,
                  family = "Asap") +
  geom_smooth(aes(x = avg, y = total_btu),
              method = "lm",
              color = "black",
              size = 0.5,
              linetype = "dashed",
              se = FALSE,
              inherit.aes = FALSE) +
  scale_y_log10(expand = c(0.1, 0)) +
  scale_color_manual(values = c("#CFCFCF", "#EE4A1E"),
                     name = "Region") +
  labs(title = "Northeast states generate more solar energy from less sunlight",
       subtitle = "Relative to states in the North Central, South, and West regions, states in the Northeast generated \nmore solar energy in 2016 than what their solar irradiance levels might suggest.",
       x = "Average Annual Global Horizonal Irradiance (kWh/m^2/day)",
       y = "Log Solar Energy Generated in 2016 (BTUs)",
       caption = "Data sources: NREL (US Dept of Energy), SEDS (U.S. Energy Information Administration)") +

  annotate("segment", 
           x = 3.8, xend = 3.55, y = 5000, yend = 5000,
           arrow = arrow(length = unit(0.2, "cm")),
           color = "#000000") +
  annotate("segment", 
           x = 5.35, xend = 5.6, y = 5000, yend = 5000,
           arrow = arrow(length = unit(0.2, "cm")),
           color = "#000000") +
  annotate("text",
           x = 3.8, y = 3600, 
           label = "Gets less sun",
           color = "#000000",
           family = "Asap",
           size = 3, 
           hjust = 1) +
  annotate("text", 
           x = 5.35, y = 3600, 
           label = "Gets more sun",
           color = "#000000",
           family = "Asap",
           size = 3, 
           hjust = 0) +
  theme_custom() +
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        legend.position = c(0.87, 0.15),
        legend.background = element_rect(color = "#BFBFBF"))

```

A rough upward trend seems to hold for the Western states, although there seems to be a lot of unexplained variation towards the lower end of the irradiance range. Among the Northeast states in red above, New York, New Jersey, and Massachussetts in particular are generating way more solar energy than neighboring states that get just as much sunlight, if not more.

While there are plenty of factors that impact the efficiency with which you generate solar energy - tilt, weather, temperature, age of technology, etc. - my immediate guess is that the most straightforward way to ramp up your output is to have more solar panels. 

# Which states have the most solar panels?

To answer this question, we'll use historical solar panel installation data from [OpenPV](https://openpv.nrel.gov/), the open-source database maintained by NREL. 

```{r, message = FALSE, warning = FALSE, results = 'hide'}
# Import solar panel data
panels <- read_csv(here('data', 'data-solar-panels', 'openpv_all.csv'),
                      col_types = cols_only(state = "c",
                                            date_installed = "c",
                                            zipcode = "c",
                                            cost = "c",
                                            install_type = "c"),
                      quoted_na = TRUE)

# Clean up date field and extract year 
panels %<>%
  mutate(date_installed = as.Date(date_installed, format = '%m/%d/%Y')) %>%
  mutate(year_installed = year(date_installed))

# Clean up install_type labels for residential panels 
panels %<>%
  mutate(install_type = tools::toTitleCase(tolower(install_type))) %>%
  mutate(install_type = ifelse(install_type == "Residential/Sf", "Residential", install_type))
```

An easy way for a state to have lots of solar panels is to have lots of people, but that's not a particularly novel insight. Thus, a critical second step is to normalize our solar panel counts by population size - this lets us identify the states with high numbers of solar panels relative to how many people they have. 

This data is normally collected by the Census bureau, but the [National Cancer Institute](https://seer.cancer.gov/popdata/download.html) has a nicely-bundled dataset that combines census counts and inter-census estimates from 1969 to 2016. So that is the dataset we'll use.  

```{r, message = FALSE, warning = FALSE, results = 'hide'}
# Import population data
pop <- read_csv(here('data', 'data-population-estimates',
                     'us.1969_2016.19ages.adjusted.txt'),
                col_types = 'c',
                col_names = FALSE)

# Extract individual variables from non-separated text data
# Then discard demographic characteristics and summarize by year-state
pop %<>%
  mutate(year = as.numeric(substr(X1, 1, 4)),
         state = substr(X1, 5, 6),
         state_fips = substr(X1, 7, 8),
         county_fips = substr(X1, 9, 11),
         seer_registry = substr(X1, 12, 13),
         race = substr(X1, 14, 14),
         origin = substr(X1, 15, 15),
         sex = substr(X1, 16, 16),
         age = as.numeric(substr(X1, 17, 18)),
         population = as.numeric(substr(X1, 19, 27))) %>%
  group_by(year, state) %>%
  summarize(total_pop = sum(population))
```

Wrangling both population and solar panel data into state-year count formats and joining them: 

```{r}
# 1. Group by year and fill in empty years with 0 installs
panels_by_pop <- panels %>%
  filter(install_type == "Residential") %>%
  group_by(state, year_installed) %>%
  count() %>%
  ungroup() %>%
  complete(state, year_installed, fill = list(n = 0)) %>%
  rename(year = year_installed)

# 2. Inner-join population data
# 3a. Get cumulative sum of installations by state
# 3b. Calculate number of panels per 10,000 people
panels_by_pop %<>%
  inner_join(pop, by = c('state', 'year')) %>%
  # filter(year != 1969) %>%
  mutate(sum_n = ave(n, state, FUN = cumsum)) %>%
  mutate(panels_per_10k = (sum_n / total_pop) * 10000)
```

Now, let's briefly check which states have the largest number of residential solar panels installed relative to the number of residents they have.

```{r, fig.align = 'center', fig.width = 4, fig.height = 3}
panels_by_pop %>%
  mutate(region = state.region[match(state, state.abb)]) %>%
  mutate(region = factor(region,
                         levels = c("West", "Northeast", "South", "North Central"))) %>%
  mutate(highlight = ifelse(region == "Northeast", TRUE, FALSE)) %>%
  filter(!is.na(region)) %>%
  filter(year == 2016) %>%
  ggplot(aes(x = reorder(state, -panels_per_10k), 
             y = panels_per_10k,
             fill = highlight)) +
  geom_bar(stat = 'identity',
           show.legend = FALSE) +
  facet_grid(. ~ region,
             scales = "free_x",
             space = "free_x") +
  # geom_text(data = data_frame(state = "NJ",
  #                                panels_per_10k = 95,
  #                                region = factor("Northeast",
  #                                   levels = c("West", "Northeast", "South", "North Central")),
  #                                highlight = TRUE),
  #           aes(label = "MA had the 3rd-most \nhousehold solar panels \nper capita"),
  #           hjust = 0,
  #           vjust = 1,
  #           size = 3,
  #           color = "grey40",
  #           nudge_x = -0.3) +
  scale_fill_manual(values = c('grey', 'red')) +
  labs(title = 'Northeast states are surprisingly well-represented in solar panel counts',
       subtitle = 'Adjusting for state population size, NY, MA, and NJ (marked in red below) respectively have the \n3rd, 5th and 10th-most residential solar panel installations per capita.',
       x = 'State',
       y = 'Panels per 10,000 people',
       caption = 'Data sources: NREL (US Dept of Energy), National Cancer Institute') +
  theme_custom() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.major.x = element_blank())

```

Sure enough - Northeast states like Massachussetts, New Jersey, and Connecticut are among states with the most solar panels per capita. The question now becomes - **why**? As we saw before, the Northeast region as a group receives the lowest annual solar irradiance among all the states. I definitely wouldn't go to Boston for a beach weekend (let alone anywhere along the Jersey Shore). 

My broad hypothesis is that installing a solar panel system is primarily a financial decision. Buyers put up with a high fixed cost upfront but enjoy long-term savings in the future, so the cheaper the cost of installation, the more likely installing solar panels will make financial sense. Particularly - the policy student in me ask to ask - what can state and local governments to do decrease this cost?

# Decreasing the cost of Solar Panels with Tax Incentives

Here, I'm interested in the effect of state and federal policies that provide tax incentives for installing renewable energy systems. We know that the federal solar tax credit incentive was implemented in 2005 and is still in effect. For individual states, we'll have to look at data from the [Database of State Incentives for Renewables & Efficiency (DSIRE)](http://www.dsireusa.org/resources/data-and-tools/) maintained by N.C. State University. 

```{r, warning=FALSE, message=FALSE, results='hide'}
# Import master list of programs
policy <- read_csv(here('data', 'data-state-policies', 'dsire-2019-01',
                        'program.csv'))

# Import relevant data to merge on
policy_states <- read_csv(here('data', 'data-state-policies', 'dsire-2019-01',
                               'state.csv')) %>%
  select(id, name) %>%
  rename(state = name)

policy_impl <- read_csv(here('data', 'data-state-policies', 'dsire-2019-01',
                              'implementing_sector.csv')) %>%
  select(id, name) %>%
  rename(implementing_sector = name)

policy_cats <- read_csv(here('data', 'data-state-policies', 'dsire-2019-01',
                             'program_category.csv')) %>%
  rename(program_category = name)

policy_types <- read_csv(here('data', 'data-state-policies', 'dsire-2019-01',
                              'program_type.csv')) %>%
  select(id, name) %>%
  rename(program_type = name)

policy_tech_link <- read_csv(here('data', 'data-state-policies', 'dsire-2019-01',
                                  'program_technology.csv'))

policy_tech <- read_csv(here('data', 'data-state-policies', 'dsire-2019-01',
                             'technology.csv')) %>%
  select(id, name, technology_category_id) %>%
  rename(technology = name)

policy_tech_cat <- read_csv(here('data', 'data-state-policies', 'dsire-2019-01',
                                 'technology_category.csv')) %>%
  rename(technology_category = name)

policy_energy_cat <- read_csv(here('data', 'data-state-policies', 'dsire-2019-01',
                                   'energy_category.csv')) %>%
  rename(energy_category = name)

policy_sector_link <- read_csv(here('data', 'data-state-policies', 'dsire-2019-01',
                                    'program_sector.csv'))

policy_sector <- read_csv(here('data', 'data-state-policies', 'dsire-2019-01',
                               'sector.csv')) %>%
  select(id, name, parent_id) %>%
  rename(sector = name)

# Merge on relevant data and replace labels with real values
policy %<>%
  left_join(policy_states, by = c("state_id" = "id")) %>%
  left_join(policy_impl, by = c("implementing_sector_id" = "id")) %>%
  left_join(policy_cats, by = c("program_category_id" = "id")) %>%
  left_join(policy_types, by = c("program_type_id" = "id")) %>%
  left_join(policy_tech_link, by = c("id" = "program_id")) %>%
  left_join(policy_tech, by = c("technology_id" = "id")) %>%
  left_join(policy_tech_cat, by = c("technology_category_id" = "id")) %>%
  left_join(policy_energy_cat, by = c("energy_category_id" = "id")) %>%
  left_join(policy_sector_link, by = c("id" = "program_id")) %>%
  left_join(policy_sector, by = c("sector_id" = "id")) %>%
  left_join(policy_sector, by = c("parent_id" = "id")) %>%
  rename(sector = sector.x, 
         parent_sector = sector.y)
  
# Drop auxiliary dataframes from memory
rm(policy_states, policy_impl, policy_cats, policy_types, policy_tech_link,
   policy_tech, policy_tech_cat, policy_energy_cat, policy_sector_link,
   policy_sector)

# Drop extraneous information and retain only useful columns
policy %<>%
  filter(technology_category == "Solar Technologies") %>%
  filter(technology == "Solar Photovoltaics") %>%
  filter(program_category == "Financial Incentive") %>%
  filter(is_entire_state == 1) %>%
  filter(!is.na(start_date) | !is.na(start_date_text)) %>% 
  select(id, name, state, start_date, start_date_text, end_date, implementing_sector, 
         program_category, program_type, technology, technology_category,
         energy_category, sector, parent_sector)
```

Frustratingly, there are two separate columns for each incentive program's start date - one in date format and one in text format - and there are some cases where a start date is listed in text but not in a clean, machine-readable date format. This start date is key to knowing if a state had an active renewable tax incentive in a given year or not, so we'll briefly get into a rare bit of manual data manipulation:

```{r}
# Fix start_date entries that are blank but have data in start_date_text column
policy %<>%
  mutate(start_date = replace(start_date, id == 75, as.POSIXct("01/01/1999", format = "%m/%d/%Y"))) %>%
  mutate(start_date = replace(start_date, id == 80, as.POSIXct("01/01/1998", format = "%m/%d/%Y"))) %>%
  mutate(start_date = replace(start_date, id == 83, as.POSIXct("01/01/2001", format = "%m/%d/%Y"))) %>%
  mutate(start_date = replace(start_date, id == 192, as.POSIXct("01/01/1988", format = "%m/%d/%Y"))) %>%
  mutate(start_date = replace(start_date, id == 248, as.POSIXct("01/01/2001", format = "%m/%d/%Y"))) %>%
  mutate(start_date = replace(start_date, id == 297, as.POSIXct("01/01/2003", format = "%m/%d/%Y"))) %>%
  mutate(start_date = replace(start_date, id == 351, as.POSIXct("01/01/2010", format = "%m/%d/%Y"))) %>%
  mutate(start_date = replace(start_date, id == 635, as.POSIXct("01/01/2001", format = "%m/%d/%Y"))) %>%
  mutate(start_date = replace(start_date, id == 636, as.POSIXct("01/01/2001", format = "%m/%d/%Y"))) %>%
  mutate(start_date = replace(start_date, id == 917, as.POSIXct("01/01/2003", format = "%m/%d/%Y"))) %>%
  mutate(start_date = replace(start_date, id == 1220, as.POSIXct("01/01/2002", format = "%m/%d/%Y"))) %>%
  mutate(start_date = replace(start_date, id == 1234, as.POSIXct("01/01/2005", format = "%m/%d/%Y"))) %>%
  mutate(start_date = replace(start_date, id == 1837, as.POSIXct("01/01/2006", format = "%m/%d/%Y"))) %>%
  mutate(start_date = replace(start_date, id == 2363, as.POSIXct("01/01/2004", format = "%m/%d/%Y"))) %>%
  mutate(start_date = replace(start_date, id == 2511, as.POSIXct("01/01/2003", format = "%m/%d/%Y"))) %>%
  mutate(start_date = replace(start_date, id == 3223, as.POSIXct("01/01/2011", format = "%m/%d/%Y"))) %>%
  mutate(start_date = replace(start_date, id == 3352, as.POSIXct("01/01/2011", format = "%m/%d/%Y"))) %>%
  mutate(start_date = replace(start_date, id == 3383, as.POSIXct("01/01/2009", format = "%m/%d/%Y"))) %>%
  mutate(start_date = replace(start_date, id == 3603, as.POSIXct("01/01/2011", format = "%m/%d/%Y"))) %>%
  mutate(start_date = replace(start_date, id == 3604, as.POSIXct("01/01/2011", format = "%m/%d/%Y"))) %>%
  mutate(start_date = replace(start_date, id == 3701, as.POSIXct("01/01/2009", format = "%m/%d/%Y"))) %>%
  mutate(start_date = replace(start_date, id == 3706, as.POSIXct("01/01/2009", format = "%m/%d/%Y"))) %>%
  mutate(start_date = replace(start_date, id == 3707, as.POSIXct("01/01/2009", format = "%m/%d/%Y"))) %>%
  mutate(start_date = replace(start_date, id == 3708, as.POSIXct("01/01/2009", format = "%m/%d/%Y"))) %>%
  mutate(start_date = replace(start_date, id == 3709, as.POSIXct("01/01/2009", format = "%m/%d/%Y"))) %>%
  mutate(start_date = replace(start_date, id == 3710, as.POSIXct("01/01/2009", format = "%m/%d/%Y"))) %>%
  mutate(start_date = replace(start_date, id == 3760, as.POSIXct("01/01/2009", format = "%m/%d/%Y"))) %>%
  mutate(start_date = replace(start_date, id == 3761, as.POSIXct("01/01/2009", format = "%m/%d/%Y"))) %>%
  mutate(start_date = replace(start_date, id == 3969, as.POSIXct("01/01/2010", format = "%m/%d/%Y"))) %>%
  mutate(start_date = replace(start_date, id == 4067, as.POSIXct("01/01/2010", format = "%m/%d/%Y"))) %>%
  mutate(start_date = replace(start_date, id == 4111, as.POSIXct("01/01/2008", format = "%m/%d/%Y"))) %>%
  mutate(start_date = replace(start_date, id == 4168, as.POSIXct("01/01/2008", format = "%m/%d/%Y"))) %>%
  mutate(start_date = replace(start_date, id == 4419, as.POSIXct("01/01/2010", format = "%m/%d/%Y"))) %>%
  mutate(start_date = replace(start_date, id == 4476, as.POSIXct("01/01/2006", format = "%m/%d/%Y"))) %>%
  mutate(start_date = replace(start_date, id == 4551, as.POSIXct("01/01/2010", format = "%m/%d/%Y"))) %>%
  mutate(start_date = replace(start_date, id == 4857, as.POSIXct("01/01/2005", format = "%m/%d/%Y"))) %>%
  mutate(start_date = replace(start_date, id == 5321, as.POSIXct("01/01/2012", format = "%m/%d/%Y"))) %>%
  mutate(start_date = replace(start_date, id == 5679, as.POSIXct("01/01/2014", format = "%m/%d/%Y"))) %>%
  mutate(start_date = replace(start_date, id == 5850, as.POSIXct("01/01/2015", format = "%m/%d/%Y")))
```

Alright. Now that that's taken care of, let's look at which states provided renewable tax incentives specifically for residential photovoltaic systems (i.e. household-scale solar panels) and when: 

```{r, warning=FALSE, message=FALSE, fig.align = 'center', fig.width = 4, fig.height = 5}
policy %>%
  filter(sector == "Residential") %>% 
  filter(!program_type %in% c("Corporate Tax Credit")) %>%
  select(state, start_date, end_date) %>%
  mutate(start_year = year(start_date),
         end_year = ifelse(end_date > now(), NA, year(end_date))) %>% 
  select(state, start_year, end_year) %>%
  group_by(state) %>% 
  mutate(start_year = min(start_year), 
         end_year = max(end_year)) %>%
  mutate(end_year = ifelse(is.na(end_year), 2019, end_year)) %>%
  unique() %>% 
  ungroup() %>% 
  rowwise() %>%
  do(data.frame(state = .$state, 
                year = seq(.$start_year, .$end_year, by = 1))) %>%
  mutate(policy = 1) %>%
  complete(nesting(state), year, fill = list(policy = 0)) %>%
  mutate(region = state.region[match(state, state.name)]) %>%
  mutate(region = factor(region, levels = c("West", "Northeast", "South", "North Central"))) %>%
  mutate(stateabb = state.abb[match(state, state.name)]) %>%
  filter(!is.na(stateabb)) %>%
  group_by(state) %>%
  mutate(num_years = sum(policy)) %>%
  mutate(policy = ifelse(policy == 1, TRUE, FALSE)) %>%
  ##### PLOT BEGINS
  ggplot(aes(x = year, y = reorder(stateabb, num_years))) +
  geom_tile(aes(fill = policy),
            color = "white",
            size = 0.5) +
  # facet_grid(region ~ .,
  #            scales = "free_y",
  #            space = "free_y") +
  scale_fill_manual(breaks = c(TRUE),
                    values = c("#CFCFCF", "#EE4A1E"),
                    name = "Residential ITCs in Effect?") +
  scale_x_continuous(position = "top",
                     breaks = c(1980, 1990, 2000, 2010)) +
  labs(title = "Renewable tax incentives only took off in mid-2000s",
       subtitle = "Massachussetts, New York, and Iowa were the first states to offer tax incentives to households \nthat installed solar panels. Most other states followed after the federal Solar Investment Tax \nCredits (ITCs) began in 2006.",
       x = "Year",
       y = "State",
       caption = "Data source: DSIRE (NC State Univ.)") +
  theme_custom() +
  theme(panel.grid = element_blank(),
        axis.title.y = element_blank(),
        legend.position = c(0.2, 0.08),
        legend.background = element_rect(fill = "#FFFFFF",
                                         linetype = "blank"),
        axis.text.y.left = element_text(margin = margin(0, 0, 0, 20)))
```

It appears that the availability of renewable ITCs only tell part of the story. Among the states that we were previously interested in, Massachussetts (along with Iowa and New Hampshire) was among the earliest states in the country to implement tax incentive programs in the form of property tax exemption between 1975 and 1980. New York only implemented a similar property tax exemption in 1988. Meanwhile, the earliest incentive program available to the residential sector in New Jersey was the adoption of Solar Renewable Energy Certificates (SREC) in 2004, where the state could purchase surplus solar energy from households via SRECs in order to meet the renewable energy production quota set in its Renewable Portfolio Standard. 


```{r, include = FALSE}
# TODO: Put this in annotation above
policy %>%
  filter(state == "New Jersey") %>%
  filter(sector == "Residential") %>% 
  filter(!program_type %in% c("Corporate Tax Credit")) %>%
  arrange(start_date) %>%
  head(6)
```

How does the availability of these incentives correspond with solar panel installation rates in each state? Do installation rates increase when they're financially incentivized?

```{r, warning=FALSE, message=FALSE, fig.align = 'center', fig.width = 5, fig.height = 4}
# Plot of solar panel installation growth vs. 
panels_by_pop %>%
  mutate(statename = state.name[match(state, state.abb)]) %>%
  left_join(policy %>%
               filter(sector == "Residential") %>% 
               filter(!program_type %in% c("Corporate Tax Credit")) %>%
               group_by(state) %>%
               mutate(start_year = year(min(start_date))) %>%
               select(state, start_year) %>%
               unique(),
            by = c("statename" = "state")) %>%
  select(state, year, start_year, panels_per_10k) %>% 
  ggplot() +
  geom_step(aes(x = year, y = panels_per_10k)) +
  facet_wrap(. ~ fct_reorder(state, start_year)) +
  geom_rect(data = policy %>%
              filter(sector == "Residential") %>%
              filter(!program_type %in% c("Corporate Tax Credit")) %>%
              select(state, start_date, end_date) %>%
              mutate(state = state.abb[match(state, state.name)]) %>%
              filter(!is.na(state)) %>%
              mutate(start_year = year(start_date),
                     end_year = ifelse(end_date > now(), NA, year(end_date))) %>%
              select(state, start_year, end_year) %>%
              group_by(state) %>%
              mutate(start_year = min(start_year),
                     end_year = max(end_year)) %>%
              mutate(end_year = ifelse(is.na(end_year), 2019, end_year)) %>%
              unique(),
            aes(xmin = start_year, xmax = end_year, ymin = 0, ymax = Inf),
            fill = "goldenrod1",
            alpha = 0.5) +
  geom_vline(aes(xintercept = 2006), 
             color = "red") +
  scale_y_log10(breaks = c(0.01, 1, 100),
                labels = c(0.01, 1, 100)) +
  scale_x_continuous(breaks = c(1970, 1990, 2010)) +
  labs(title = "No clear link between residential tax incentives and solar panel uptake",
       subtitle = "Most states appear to have periods of solar panel growth unrelated to the period at which state-based tax incentives \nfor residential renewable energy systems are available. These periods are marked in yellow below.",
       x = "Year",
       y = "Log Panels per 10,000 people",
       caption = "Data sources: NREL (US Dept of Energy), DSIRE (NC State Univ.)") +
  theme_custom() +
  theme(panel.grid = element_blank())
```


```{r, fig.align = 'center', fig.width = 4, fig.height = 4}
panels_by_pop %>%
  select(state, year, panels_per_10k) %>%
  mutate(region = state.region[match(state, state.abb)]) %>%
  filter(!is.na(region)) %>%
  group_by(year) %>%
  arrange(year, desc(panels_per_10k)) %>%
  mutate(ranking = row_number()) %>%
  mutate(highlight = ifelse(state %in% c("NY", "MA", "NJ"), TRUE, FALSE)) %>%
  ggplot(aes(x = year, y = ranking, group = state, color = highlight)) +
  geom_line(na.rm = TRUE,
            show.legend = FALSE) +
  geom_point(na.rm = TRUE,
             show.legend = FALSE) +
  geom_text(data = . %>% filter(year == 1995),
            aes(x = year, y = ranking, label = state, color = highlight),
            nudge_x = -1,
            size = 3.5,
            show.legend = FALSE) +
  geom_text(data = . %>% filter(year == 2016),
            aes(x = year, y = ranking, label = state, color = highlight),
            nudge_x = 1,
            size = 3.5,
            show.legend = FALSE) +
  scale_y_reverse() +
  scale_x_continuous(limits = c(1993, 2018),
                     breaks = seq(1995, 2015, 5)) +
  scale_color_manual(values = c("#CFCFCF", "#EE4A1E")) +
  theme_custom() +
  theme(panel.grid = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y = element_blank())
  
```



# Next steps

As an ongoing project, we will next look at the following factors as possible correlates of solar panel installation rates:

- Cost of electricity in each state 

- Cost of the solar panels themselves

- A deeper look into the types of state tax incentives enacted, i.e. whether it was a tax deduction, a tax credit, a tax exemption, a low-interest loan program, size of the state's renewable portfolio standard, and so on.


# Data Sources

- Solar Energy Generation: [State Energy Data Systems (SEDS), U.S. Energy Information Administration](https://www.eia.gov/state/seds/)

- Solar Irradiance: [National Renewable Energy Laboratory, U.S. Department of Energy](https://www.nrel.gov/gis/data-solar.html)

- Solar Panel Installations: [OpenPV Project, NREL, U.S. Department of Energy](https://openpv.nrel.gov/)

- Population estimates: [Surveillance, Epidemiology and End Results (SEER) Program, National Cancer Institute](https://seer.cancer.gov/popdata/download.html)

- State Policies: [Database of State Incentives for Renewables & Efficiency (DSIRE), North Carolina State University](http://www.dsireusa.org/resources/data-and-tools/)

