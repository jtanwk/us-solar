---
title: "Shining a Light on Solar Panel Usage in the U.S."
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(magrittr) # extended pipe functionality
library(lubridate) # dealing with date objects
library(ggrepel) # for neater text labels
library(gghighlight) # for easier highlighting
library(GGally) # for scatterplot matrices
library(here) 
library(readxl)  
```

# Introduction

Investment in renewable energy is such a fascinating policy area. It's one of the few that feature the interplay of energy as a national utility, yet with semi-reliance on individuals and corporations as contributors to industry supply - e.g. in installing solar panels or, at a greater scale, solar farms. 

Much of the national conversation around renewable energy today tends to revolve around switching from gasoline power to low-emission alternatives (say, a regular petrol car vs. a Tesla, or a city transit system switching to electric buses). In many cases, this makes sense - the Department of Energy states that ["electricity is less expensive than gasoline and [electric vehicles] are more efficient than gasoline vehicles"](https://www.energy.gov/eere/electricvehicles/saving-fuel-and-vehicle-costs). 

More efficient or not, however, this still shifts the energy load from gasoline to the electrical grid, which itself is mostly generated from non-renewable sources. The *generation* of energy from renewable sources is a critical part of reducing emissions when we as a species increasingly consume more and more energy (looking at you, bitcoin miners). The question I'm more preoccupied with is: where is all this energy coming from? 

# Where all this energy is coming from

First, we'll take a look at data on solar photovoltaic energy generated by the commercial, industrial, power and residential sectors, courtesy of the U.S. Energy Information Administration's [State Energy Data Systems (SEDS) database](https://www.eia.gov/state/seds/).

```{r, warning=FALSE, message=FALSE, results='hide'}
# Import solar energy generation data
gen <- read_csv(here('data', 'data-power-generation', 'Complete_SEDS.csv'))

# Extract desired data and replace labels with actual name of sourse
gen %<>%
  filter(MSN %in% c("SOCCP", "SOEGP", "SOICP", "SOR7P")) %>% # solar codes
  filter(!StateCode %in% c("US", "X3", "X5")) %>% # filter out Total and Offshore
  mutate(source = ifelse(MSN == "SOCCP", "Commercial", 
                         ifelse(MSN == "SOEGP", "Electric Power",
                                ifelse(MSN == "SOICP", "Industrial",
                                       "Residential"))))
```

Why focus on solar energy? Of all the common sources of renewable energy - solar, wind, hydroelectric, geothermal, etc. - solar energy fascinates me because it's so *participatory*. You can't install a wind turbine in your backyard or dam up the local river, but you could invest in a set of solar panels for your house fairly easily. In the SEDS data, solar energy is also the only renewable source of energy to have a line item for "generation by small-scale applications in the residential sector".

```{r, fig.align = 'center', fig.width = 8, fig.height = 6}
gen %>%
  group_by(Year, source) %>%
  summarize(total_btu = sum(Data)) %>%
  filter(Year >= 1980) %>%
  mutate(highlight = ifelse(source == "Residential", TRUE, FALSE)) %>% 
  ggplot(aes(x = Year, y = total_btu/1000, group = source, color = highlight)) +
  geom_line(show.legend = FALSE,
            na.rm = TRUE) +
  scale_color_manual(values = c('grey', 'red')) +
  labs(title = "Residential systems are the 2nd-largest source of solar energy in the US",
       subtitle = "While utility-owned solar farms are the largest generators of solar energy, small-scale residential \nsystems overtook the commercial sector in 2011 to become the 2nd-largest source as of 2016.",
       x = "Year",
       y = "Annual Energy Generated (1,000 BTUs)",
       caption = "Data source: SEDS (U.S. Energy Information Administration)") +
  geom_text_repel(data = . %>% filter(Year == 2016),
                  aes(x = Year, y = total_btu/1000, label = source),
                  show.legend = FALSE,
                  nudge_x = 1,
                  na.rm = TRUE) +
  theme_minimal() + 
  theme(panel.grid.minor = element_blank()) +
  xlim(2000, 2019)
```

A logical next question is: where are all these residential solar panels? 

```{r, fig.align='center', fig.width = 8, fig.height = 8}
gen %>%
  filter(Year == max(Year)) %>%
  filter(source == "Residential") %>%
  group_by(StateCode) %>%
  summarize(total_btu = sum(Data)) %>%
  mutate(dev_fr_mean = total_btu / mean(total_btu, na.rm = TRUE)) %>%
  filter(dev_fr_mean != 0) %>% # SD and ND mess with log scale 
  ggplot(aes(x = reorder(StateCode, dev_fr_mean), y = dev_fr_mean)) +
  geom_point(stat = 'identity', 
           na.rm = TRUE) + 
  scale_y_log10(position = "right",
                breaks = c(0.01, 0.1, 1, 10, 100),
                labels = c("0.01x", "0.1x", "1x", "10x", "100x")) +
  labs(title = "CA generates more than 24 times more solar energy than the national average",
       subtitle = "In 2016, California was the single largest generator of solar energy from residential systems, producing \nmore than 24 times the solar energy produced by the average state (measured in BTU). \nSouth Dakota and North Dakota are omitted below, having produced no solar energy in 2016.",
       x = "", 
       y = "Solar Energy Generated Relative to Avg. State",
       caption = "Data source: SEDS (U.S. Energy Information Administration)") +
  geom_text(aes(label = StateCode, 
                 y = ifelse(dev_fr_mean > 1, dev_fr_mean * 1.4, dev_fr_mean / 1.4)),
            size = 3.3) +
  geom_hline(yintercept = 1, 
             color = "grey") +
  theme_minimal() + 
  theme(panel.grid.minor = element_blank(),
        panel.grid.major.y = element_blank(),
        axis.text.y = element_blank()) +
  coord_flip()

# TODO: Add annotations around 1x line with interpretation of horizontal position
```

Unsurprisingly, California was the single largest **residential** generator of solar energy in 2016 - in fact, California and Arizona combined generated more than half of the national total. What is a bit more of a surprise is how high on the list the Northeast states like New York (#3), New Jersey (#4), and Massachussetts (#6) lie, particularly in comparison to known sunny states like Nevada (#9), Texas (#10) and Florida (#13).

That brings me to my next question: does the amount of sunlight each state receives correlate with the solar energy it generates? 

# Do sunny states generate more solar energy?

For this, we'll use solar irradiance data from the Department of Energy's [National Renewable Energy Laboratory](https://www.nrel.gov/gis/data-solar.html). Specifically, we're looking at Global Horizontal Irradiance (GHI), which is the amount of solar radiation a surface receives if placed horizonal to the ground, measured in kilowatt-hours per square meter per day ($kWh/m^2/day$). Since we're dealing with residential installations here, roofs might be sloped in a particular direction, but we'll assume that they more or less average out to horizontal position in the full dataset. 

```{r, warning=FALSE, message=FALSE}
# Import solar irradiance data
ghi <- read_excel(here('data', 'data-solar-irradiance', 'solarsummaries.xlsx'),
                     sheet = 'GHI State',
                     range = 'A1:BO52',
                     col_types = c('text', rep('numeric', 66)))

# Reshape from wide to long
ghi %<>%
  gather(key = metric, value =  value, -c("State", "State FIPS")) 

# Remove time period from metric name and reshape back to wide-ish
# Now unit of analysis is state-month-estimate instead of state-estimate
ghi %<>%
  mutate(period = substr(ghi$metric, 1, str_locate(ghi$metric, " ") - 1)) %>%
  mutate(attr = substr(ghi$metric, str_locate(ghi$metric, " ") + 1, 
                       nchar(ghi$metric))) %>%
  mutate(period = substr(period, 1, 3)) %>%
  mutate(period = factor(period,
                         levels = c('Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                                    'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec',
                                    'Ann'))) %>%
  select(-metric) %>%
  spread(key = attr, value = value) %>%
  rename(avg = 'Average (kWh/m2/day)',
         max = 'Average Maximum (kWh/m2/day)',
         min = 'Average Minimum (kWh/m2/day)',
         median = 'Average Median (kWh/m2/day)',
         sd = 'Average Standard Deviation (kWh/m2/day)')
```

So how does solar energy generation relate to solar irradiance? 

```{r, fig.align="center", fig.width = 8, fig.height = 6}
gen %>%
  filter(Year == max(Year)) %>%
  filter(source == "Residential") %>%
  group_by(StateCode) %>%
  summarize(total_btu = sum(Data)) %>%
  inner_join(ghi %>% 
               mutate(StateCode = state.abb[match(State, state.name)]) %>%
               filter(period == "Ann", !is.na(avg)) %>%
               select(StateCode, avg),
             by = c("StateCode" = "StateCode")) %>% 
  filter(total_btu != 0) %>%  # SD and ND mess with log scale
  mutate(highlight = ifelse(StateCode %in% c("NY", "MA", "NJ"), TRUE, FALSE)) %>%
  ggplot(aes(x = avg, y = total_btu, label = StateCode, color = highlight)) +
  geom_point(show.legend = FALSE) +
  geom_text_repel(show.legend = FALSE) +
  geom_smooth(aes(x = avg, y = total_btu),
              method = "lm",
              color = "black",
              size = 0.5,
              linetype = "dashed",
              se = FALSE,
              inherit.aes = FALSE) +
  scale_y_log10() +
  scale_color_manual(values = c("grey", "red")) +
  labs(title = "NY, MA, NJ give more than they get, relative to other states",
       subtitle = "Northeast states - in particular New York, Massachussetts, and New Jersey - generated more \nsolar energy in 2016 than what their annual solar irradiance levels might suggest. \nNortheast states are highlighted in red below.",
       x = "Average Annual Global Horizonal Irradiance (kWh/m^2/day)",
       y = "Log Solar Energy Generated in 2016 (BTU)",
       caption = "Data sources: NREL (US Dept of Energy), SEDS (U.S. Energy Information Administration)") +
  theme_minimal() +
  theme(panel.grid.minor = element_blank())
```

A rough upward trend seems to hold for the Western states, although there seems to be a lot of unexplained variation towards the lower end of the irradiance range. Among the Northeast states in red above, New York, New Jersey, and Massachussetts in particular are generating way more solar energy than neighboring states that get just as much sunlight, if not more.

While there are plenty of factors that impact the efficiency with which you generate solar energy - tilt, weather, temperature, age of technology, etc. - my immediate guess is that the most straightforward way to ramp up your output is to have more solar panels. 

# Do states with the most solar panels generate the most energy?

To answer this question, we'll use historical solar panel installation data from [OpenPV](https://openpv.nrel.gov/), the open-source database maintained by NREL. 

```{r, message=FALSE, warning=FALSE, results='hide'}
# Import solar panel data
panels <- read_csv(here('data', 'data-solar-panels', 'openpv_all.csv'),
                      col_types = cols_only(state = "c",
                                            date_installed = "c",
                                            zipcode = "c",
                                            cost = "c",
                                            install_type = "c"),
                      quoted_na = TRUE)

# Clean up date field and extract year 
panels %<>%
  mutate(date_installed = as.Date(date_installed, format = '%m/%d/%Y')) %>%
  mutate(year_installed = year(date_installed))

# Clean up install_type labels for residential panels 
panels %<>%
  mutate(install_type = tools::toTitleCase(tolower(install_type))) %>%
  mutate(install_type = ifelse(install_type == "Residential/Sf", "Residential", install_type))
```

An easy way for a state to have lots of solar panels is to have lots of people, but that's not a particularly novel insight. Thus, a critical second step is to normalize our solar panel counts by population size - this lets us identify the states with high numbers of solar panels relative to how many people they have. 

This data is normally collected by the Census bureau, but the [National Cancer Institute](https://seer.cancer.gov/popdata/download.html) has a nicely-bundled dataset that combines census counts and inter-census estimates from 1969 to 2016. So that is the dataset we'll use.  

```{r, message=FALSE, warning=FALSE, results='hide'}
# Import population data
pop <- read_csv(here('data', 'data-population-estimates',
                     'us.1969_2016.19ages.adjusted.txt'),
                col_types = 'c',
                col_names = FALSE)

# Extract individual variables from non-separated text data
# Then discard demographic characteristics and summarize by year-state
pop %<>%
  mutate(year = as.numeric(substr(X1, 1, 4)),
         state = substr(X1, 5, 6),
         state_fips = substr(X1, 7, 8),
         county_fips = substr(X1, 9, 11),
         seer_registry = substr(X1, 12, 13),
         race = substr(X1, 14, 14),
         origin = substr(X1, 15, 15),
         sex = substr(X1, 16, 16),
         age = as.numeric(substr(X1, 17, 18)),
         population = as.numeric(substr(X1, 19, 27))) %>%
  group_by(year, state) %>%
  summarize(total_pop = sum(population))
```

Wrangling both population and solar panel data into state-year count formats and joining them: 

```{r}
# 1. Group by year and fill in empty years with 0 installs
panels_by_pop <- panels %>%
  filter(install_type == "Residential") %>%
  group_by(state, year_installed) %>%
  count() %>%
  ungroup() %>%
  complete(state, year_installed, fill = list(n = 0)) %>%
  rename(year = year_installed)

# 2. Inner-join population data
# 3a. Get cumulative sum of installations by state
# 3b. Calculate number of panels per 10,000 people
panels_by_pop %<>%
  inner_join(pop, by = c('state', 'year')) %>%
  filter(year != 1969) %>%
  mutate(sum_n = ave(n, state, FUN = cumsum)) %>%
  mutate(panels_per_10k = (sum_n / total_pop) * 10000)
```

Now, let's briefly check which states have the largest number of residential solar panels installed relative to the number of residents they have.

```{r, fig.align = "center", fig.width = 8, fig.height = 6}
panels_by_pop %>%
  mutate(region = state.region[match(state, state.abb)]) %>%
  mutate(region = factor(region,
                         levels = c("West", "Northeast", "South", "North Central"))) %>%
  mutate(highlight = ifelse(state %in% c("NY", "MA", "NJ"), TRUE, FALSE)) %>%
  filter(!is.na(region)) %>%
  filter(year == 2016) %>%
  ggplot(aes(x = reorder(state, -panels_per_10k), 
             y = panels_per_10k,
             fill = highlight)) +
  geom_bar(stat = 'identity',
           show.legend = FALSE) +
  facet_grid(. ~ region,
             scales = "free_x",
             space = "free_x") +
  scale_fill_manual(values = c('grey', 'red')) +
  labs(title = 'Northeast states are surprisingly well-represented in solar panel counts',
       subtitle = 'Adjusting for state population size, NY, MA, and NJ (marked in red below) respectively have the 
3rd, 5th and 10th-most residential solar panel installations per capita.',
       x = 'State',
       y = 'Panels per 10,000 people',
       caption = 'Data sources: NREL (US Dept of Energy), National Cancer Institute') +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank())
```

Sure enough - Northeast states like Massachussetts, New Jersey, and Connecticut are among states with the most solar panels per capita. The question now becomes - **why**? As we saw before, the Northeast region as a group receives the lowest annual solar irradiance among all the states. I definitely wouldn't go to Boston for a beach weekend (let alone anywhere along the Jersey Shore). 

My broad hypothesis is that installing a solar panel system is primarily a financial decision. Buyers put up with a high fixed cost upfront but enjoy long-term savings in the future, so the cheaper the cost of installation, the more likely installing solar panels will make financial sense. Particularly - the policy student in me ask to ask - what can state and local governments to do decrease this cost?

# Decreasing the cost of Solar Panels with Tax Credits 

Here, I'm interested in the effect of state and federal policies that provide tax incentives for installing renewable energy systems. We know that the federal solar tax credit incentive was implemented in 2005 and is still in effect. For individual states, we'll have to look at policy adoption data, courtesy of the [Institute for Public Policy and Social Research (IPPSR) at Michigan State University](http://ippsr.msu.edu/public-policy/correlates-state-policy). 

```{r, message=FALSE, warning=FALSE, results='hide'}
# Import policy adoption data, selecting variables related to renewable energy
policy <- read_csv(here('data', 'data-state-policies', 
                        'correlatesofstatepolicyprojectv2_1.csv')) %>%
  select(c('state', 'year', 
           'corporaterenew_yearadopted',
           'environment_publicbenefit_funds',
           'frenew',
           'frpsexc',
           'frps',
           'netmeter_yearadopted',
           'renewport',
           'rps_yearadopted',
           'personaltax_yearadopted', # Renewable tax credits available?
           'Cons_Renewable'))
```

First, let's look at which states provided renewable income tax credits (ITCs) specifically for individuals (rather than corporate tax credits) and when: 

```{r, fig.align = "center", fig.width = 6, fig.height = 8}
policy %>%
  group_by(state) %>%
  filter(year >= 1990) %>%
  select(state, year, personaltax_yearadopted) %>%
  mutate(num_policy_years = sum(personaltax_yearadopted, na.rm = TRUE)) %>%
  mutate(tax_policy = ifelse(is.na(personaltax_yearadopted), FALSE, TRUE)) %>%
  mutate(region = state.region[match(state, state.name)]) %>%
  mutate(region = factor(region,
                         levels = c("West", "Northeast", "South", "North Central"))) %>%
  mutate(state_abb = state.abb[match(state, state.name)]) %>%
  filter(!is.na(region)) %>%
  ggplot(aes(x = year, y = reorder(state_abb, num_policy_years))) +
  geom_tile(aes(fill = tax_policy),
            color = "white",
            size = 0.5) +
  facet_grid(region ~ .,
             scales = "free_y",
             space = "free_y") +
  theme_minimal() +
  theme(legend.justification = "top") +
  scale_fill_manual(breaks = c(TRUE),
                    values = c('gray90', 'goldenrod1'),
                    name = "Personal Renewable ITCs in Effect?") +
  scale_x_continuous(position = "top") +
  labs(title = "Renewable income tax credits only tell part of the story",
       subtitle = 
"Among the states in the Northeast with the highest solar panel installation 
rates, Massachussetts and New York were among the earliest states to 
implement tax incentives for residential solar energy systems. New Jersey 
has not had an active incentive in effect since 2001. ",
       x = "Year",
       y = "State",
       caption = "Data source: IPPSR (Michigan State University)") +
  theme(panel.grid = element_blank(),
        legend.position = "top")
```

It appears that the availability of renewable ITCs only tell part of the story. Among the states that we were previously interested in - New York, New Jersey, and Massachussetts - NY and MA were among the earliest states to implement ITC programs for residential solar energy systems, while NJ has not had an active ITC program since 2001.

# Next steps

As an ongoing project, we will next look at the following factors as possible correlates of solar panel installation rates:

- Cost of electricity in each state 

- Cost of the solar panels themselves

- A deeper look into the types of state tax incentives enacted, i.e. whether it was a tax deduction, a tax credit, a tax exemption, a low-interest loan program, and so on.


# Data Sources

- Solar Energy Generation: [State Energy Data Systems (SEDS), U.S. Energy Information Administration](https://www.eia.gov/state/seds/)

- Solar Irradiance: [National Renewable Energy Laboratory, U.S. Department of Energy](https://www.nrel.gov/gis/data-solar.html)

- Solar Panel Installations: [OpenPV Project, NREL, U.S. Department of Energy](https://openpv.nrel.gov/)

- Population estimates: [Surveillance, Epidemiology and End Results (SEER) Program, National Cancer Institute](https://seer.cancer.gov/popdata/download.html)

- State Policies: [Correlates of State Policy, Institute of Public Policy and Social Research (IPPSR), Michigan State University](http://ippsr.msu.edu/public-policy/correlates-state-policy)

