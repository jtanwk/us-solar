---
title: "Shining a Light on US Solar Panel Adoption"
author: "Jonathan Tan"
date: "1/27/2019"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(magrittr) # extended pipe functionality
library(lubridate) # dealing with date objects
library(ggrepel) # for neater text labels
library(gghighlight) # for easier highlighting
library(here) 
library(readxl)  
```

# Introduction

Investment in renewable energy is such a fascinating policy area. It's one of the few that feature the interplay of energy as a national utility, yet with semi-reliance on individuals and corporations as contributors to industry supply - e.g. in installing solar panels or, at a greater scale, solar farms. 

Much of the national conversation around renewable energy today tends to revolve around switching from gasoline power to low-emission alternatives (say, a regular petrol car vs. a Tesla, or a city transit system switching to electric buses). In many cases, this makes sense - the Department of Energy states that ["electricity is less expensive than gasoline and [electric vehicles] are more efficient than gasoline vehicles"](https://www.energy.gov/eere/electricvehicles/saving-fuel-and-vehicle-costs). 

More efficient or not, however, this still shifts the energy load from gasoline to the electrical grid, which itself is mostly generated from non-renewable sources. The *generation* of energy from renewable sources is a critical part of reducing emissions when we as a species increasingly consume more and more energy (looking at you, bitcoin miners). The question I'm more preoccupied with is: where is all this energy coming from? 

# Where all this energy is coming from

First, we'll take a look at data on solar photovoltaic energy generated by the commercial, industrial, power and residential sectors, courtesy of the U.S. Energy Information Administration's [State Energy Data Systems (SEDS) database](https://www.eia.gov/state/seds/).

```{r, warning=FALSE, message=FALSE}
# Import solar energy generation data
gen <- read_csv(here('data', 'data-power-generation', 'Complete_SEDS.csv'))

# Extract desired data and replace labels with actual name of sourse
gen %<>%
  filter(MSN %in% c("SOCCP", "SOEGP", "SOICP", "SOR7P")) %>% # solar codes
  filter(!StateCode %in% c("US", "X3", "X5")) %>% # filter out Total and Offshore
  mutate(source = ifelse(MSN == "SOCCP", "Commercial", 
                         ifelse(MSN == "SOEGP", "Electric Power",
                                ifelse(MSN == "SOICP", "Industrial",
                                       "Residential"))))
```

Why focus on solar energy? Of all the common sources of renewable energy - solar, wind, hydroelectric, geothermal, etc. - solar energy fascinates me because it's so *participatory*. You can't install a wind turbine in your backyard or dam up the local river, but you could invest in a set of solar panels for your house fairly easily. In the SEDS data, solar energy is also the only renewable source of energy to have a line item for "generation by small-scale applications in the residential sector".

```{r, fig.align = 'center', fig.width = 8, fig.height = 6}
gen %>%
  group_by(Year, source) %>%
  summarize(total_btu = sum(Data)) %>%
  filter(Year >= 1980) %>%
  mutate(highlight = ifelse(source == "Residential", TRUE, FALSE)) %>%
  ggplot(aes(x = Year, y = total_btu, group = source, color = highlight)) +
  geom_line(show.legend = FALSE,
            na.rm = TRUE) +
  scale_color_manual(values = c('grey', 'red')) +
  labs(title = "Residential systems are the 2nd-largest source of solar energy in the U.S.",
       subtitle = "SUBTITLE!",
       x = "Year",
       y = "Annual Energy Generated (BTUs)",
       caption = "Data source: SEDS (U.S. Energy Information Administration)") +
  geom_text_repel(data = . %>% filter(Year == 2016),
                  aes(x = Year, y = total_btu, label = source),
                  show.legend = FALSE,
                  nudge_x = 1,
                  na.rm = TRUE) +
  theme_minimal() + 
  xlim(2000, 2018)
```

A logical next question is: where are all these residential solar panels? 

```{r, fig.align='center', fig.width = 6, fig.height = 8}
gen %>%
  filter(Year == max(Year)) %>%
  filter(source == "Residential") %>%
  group_by(StateCode) %>%
  summarize(total_btu = sum(Data)) %>%
  mutate(dev_fr_mean = total_btu / mean(total_btu, na.rm = TRUE)) %>%
  filter(dev_fr_mean != 0) %>% # SD and ND mess with log scale 
  ggplot(aes(x = reorder(StateCode, dev_fr_mean), y = dev_fr_mean)) +
  geom_point(stat = 'identity', 
           na.rm = TRUE) + 
  scale_y_log10(position = "right",
                breaks = c(0.01, 0.1, 1, 10, 100),
                labels = c("0.01x", "0.1x", "1x", "10x", "100x")) +
  labs(title = "CA generates >24 times more solar energy than the national average",
       subtitle = "In 2016, California was the single largest generator of solar energy from residential \nsystems, producing more than 24 times the solar energy produced by the average \nstate (measured in BTU). South Dakota and North Dakota are omitted below, \nhaving produced no solar energy in 2016.",
       x = "", 
       y = "Solar Energy Generated Relative to Avg. State",
       caption = "Data source: SEDS (U.S. Energy Information Administration)") +
  geom_text(aes(label = StateCode, 
                 y = ifelse(dev_fr_mean > 1, dev_fr_mean * 1.4, dev_fr_mean / 1.4)),
            size = 3.3) +
  geom_hline(yintercept = 1, 
             color = "grey") +
  theme_minimal() + 
  theme(panel.grid.major = element_blank(),
        axis.text.y = element_blank()) +
  coord_flip()
```

Unsurprisingly, California was the single largest **residential** generator of solar energy in 2016 - in fact, California and Arizona combined generated more than half of the national total. What is a bit more of a surprise is how high on the list the Northeast states like New York (#3), New Jersey (#4), and Massachussetts (#6) lie, particularly in comparison to known sunny states like Nevada (#9), Texas (#10) and Florida (#13).

That brings me to my next question: does the amount of sunlight each state receives correlate with the solar energy it generates? 

# Do sunny states generate more solar energy?

For this, we'll use solar irradiance data from the Department of Energy's [National Renewable Energy Laboratory](https://www.nrel.gov/gis/data-solar.html). Specifically, we're looking at Global Horizontal Irradiance (GHI), which is the amount of solar radiation a surface receives if placed horizonal to the ground, measured in kilowatt-hours per square meter per day ($kWh/m^2/day$). Since we're dealing with residential installations here, roofs might be sloped in a particular direction, but we'll assume that they more or less average out to horizontal position in the full dataset. 

```{r, warning=FALSE, message=FALSE}
# Import solar irradiance data
ghi <- read_excel(here('data', 'data-solar-irradiance', 'solarsummaries.xlsx'),
                     sheet = 'GHI State',
                     range = 'A1:BO52',
                     col_types = c('text', rep('numeric', 66)))

# Reshape from wide to long
ghi %<>%
  gather(key = metric, value =  value, -c("State", "State FIPS")) 

# Remove time period from metric name and reshape back to wide-ish
# Now unit of analysis is state-month-estimate instead of state-estimate
ghi %<>%
  mutate(period = substr(ghi$metric, 1, str_locate(ghi$metric, " ") - 1)) %>%
  mutate(attr = substr(ghi$metric, str_locate(ghi$metric, " ") + 1, 
                       nchar(ghi$metric))) %>%
  mutate(period = substr(period, 1, 3)) %>%
  mutate(period = factor(period,
                         levels = c('Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                                    'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec',
                                    'Ann'))) %>%
  select(-metric) %>%
  spread(key = attr, value = value) %>%
  rename(avg = 'Average (kWh/m2/day)',
         max = 'Average Maximum (kWh/m2/day)',
         min = 'Average Minimum (kWh/m2/day)',
         median = 'Average Median (kWh/m2/day)',
         sd = 'Average Standard Deviation (kWh/m2/day)')
```

So how does solar energy generation relate to solar irradiance? 

```{r, fig.align="center", fig.width=9, fig.height=6}
gen %>%
  filter(Year == max(Year)) %>%
  filter(source == "Residential") %>%
  group_by(StateCode) %>%
  summarize(total_btu = sum(Data)) %>%
  mutate(region = state.region[match(StateCode, state.abb)]) %>%
  inner_join(ghi %>% 
               mutate(StateCode = state.abb[match(State, state.name)]) %>%
               filter(period == "Ann", !is.na(avg)) %>%
               select(StateCode, avg),
             by = c("StateCode" = "StateCode")) %>% 
  filter(total_btu != 0) %>%  #SD and ND mess with log scale
  ggplot(aes(x = avg, y = total_btu, label = StateCode, color = region)) +
  geom_point() +
  geom_text_repel(show.legend = FALSE) +
  scale_y_log10() +
  labs(title = "NY, MA, NJ give more than they get, relative to other states",
       subtitle = "SUBTITLE!",
       x = "Average annual Global Horizonal Irradiance (kWh/m^2/day)",
       y = "Solar Energy Generated (BTU)",
       caption = "Data sources: NREL (US Dept of Energy), SEDS (U.S. Energy Information Administration)") +
  theme_minimal()
```



# References

[State Energy Data Systems (SEDS), U.S. Energy Information Administration](https://www.eia.gov/state/seds/)
[National Renewable Energy Laboratory, U.S. Department of Energy](https://www.nrel.gov/gis/data-solar.html)


































